<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SciChart 3D Scatter Plot</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      canvas {
        display: block;
      }
    </style>
  </head>
  <body>
    <div id="scichart-root" style="width: 100%; height: 100vh"></div>

    <script
      src="https://cdn.jsdelivr.net/npm/scichart@3/index.min.js"
      crossorigin="anonymous"
    ></script>

    <script type="module">
      import { Pane } from "tweakpane";
      import { toObject } from "./data.js";
      import csv from "/diabetes.csv?url&raw";

      const data = toObject(csv);
      const predictors = [
        "Insulin",
        "BMI",
        "Glucose",
        "DiabetesPedigreeFunction",
        "BloodPressure",
        "Age",
        "Pregnancies",
        "SkinThickness",
      ];

      const node = data.map((item, id) => ({
        id: id,
        Insulin: parseFloat(item.Insulin) || 0,
        BMI: parseFloat(item.BMI) || 0,
        Glucose: parseFloat(item.Glucose) || 0,
        DiabetesPedigreeFunction:
          parseFloat(item.DiabetesPedigreeFunction) || 0,
        BloodPressure: parseFloat(item.BloodPressure) || 0,
        Age: parseFloat(item.Age) || 0,
        Pregnancies: parseFloat(item.Pregnancies) || 0,
        SkinThickness: parseFloat(item.SkinThickness) || 0,
        color: item.Outcome === "1" ? "#FF0000" : "#00FF00",
      }));

      const config = {
        x: "Insulin",
        y: "BMI",
        z: "Glucose",
      };

      window.addEventListener("load", async () => {
        const {
          SciChart3DSurface,
          NumericAxis3D,
          XyzDataSeries3D,
          SpherePointMarker3D,
          CameraController,
          OrbitModifier3D,
          Vector3,
          SciChartSurface,
        } = window.SciChart;

        SciChartSurface.UseCommunityLicense();
        const { sciChart3DSurface, wasmContext } =
          await SciChart3DSurface.create("scichart-root");
        sciChart3DSurface.xAxis = new NumericAxis3D(wasmContext, {
            axisTitle: "Insulin",
          });
          sciChart3DSurface.yAxis = new NumericAxis3D(wasmContext, {
            axisTitle: "BMI",
          });
          sciChart3DSurface.zAxis = new NumericAxis3D(wasmContext, {
            axisTitle: "Glucose",
          });

        const updateChart = () => {
            sciChart3DSurface.renderableSeries.clear()
          sciChart3DSurface.xAxis = new NumericAxis3D(wasmContext, {
            axisTitle: config.x,
          });
          sciChart3DSurface.yAxis = new NumericAxis3D(wasmContext, {
            axisTitle: config.y,
          });
          sciChart3DSurface.zAxis = new NumericAxis3D(wasmContext, {
            axisTitle: config.z,
          });

          // Create the 3D scatter series
          const scatterSeries = new window.SciChart.ScatterRenderableSeries3D(
            wasmContext,
            {
              dataSeries: new XyzDataSeries3D(wasmContext, {
                xValues: node.map((point) => point[config.x]),
                yValues: node.map((point) => point[config.y]),
                zValues: node.map((point) => point[config.z]),
              }),
              pointMarker: new SpherePointMarker3D(wasmContext, {
                size: 10,
                fill: "#ff00ff", // Color should be set by node.color for each
                // fill: node.map((v) => v.color)
              }),
            }
          );

          sciChart3DSurface.renderableSeries.add(scatterSeries);
        };

        sciChart3DSurface.camera = new CameraController(wasmContext, {
          position: new Vector3(400, 400, 400),
          target: new Vector3(0, 0, 0),
        });

        sciChart3DSurface.chartModifiers.add(new OrbitModifier3D());

        const pane = new Pane({
          container: document.getElementById("gui-container"),
        });

        pane
          .addBinding(config, "x", {
            options: predictors.reduce((acc, p) => {
              acc[p] = p;
              return acc;
            }, {}),
          })
          .on("change", updateChart);
        pane
          .addBinding(config, "y", {
            options: predictors.reduce((acc, p) => {
              acc[p] = p;
              return acc;
            }, {}),
          })
          .on("change", updateChart);
        pane
          .addBinding(config, "z", {
            options: predictors.reduce((acc, p) => {
              acc[p] = p;
              return acc;
            }, {}),
          })
          .on("change", updateChart);
      });
    </script>
  </body>
</html>
